# Подробные результаты тестирования HTTP Router

[English](../en/TESTS_DETAILED.md) | **Русский** | [Deutsch](../de/TESTS_DETAILED.md) | [Français](../fr/TESTS_DETAILED.md) | [中文](../zh/TESTS_DETAILED.md)

---

## Содержание

- [1. PHPStan - Статический анализ](#1-phpstan---статический-анализ)
- [2. PHPMD - Анализ качества кода](#2-phpmd---анализ-качества-кода)
- [3. PHPCS - Проверка стиля кода](#3-phpcs---проверка-стиля-кода)
- [4. PHP-CS-Fixer - Автофикс стиля](#4-php-cs-fixer---автофикс-стиля)
- [5. Rector - Модернизация кода](#5-rector---модернизация-кода)
- [6. Юнит-тесты](#6-юнит-тесты)
- [7. Тесты безопасности](#7-тесты-безопасности)
- [8. Тесты производительности](#8-тесты-производительности)
- [9. Нагрузочные тесты](#9-нагрузочные-тесты)
- [10. Стресс-тесты](#10-стресс-тесты)
- [11. Бенчмарки](#11-бенчмарки)

---

## 1. PHPStan - Статический анализ

### Описание

PHPStan - это инструмент статического анализа для PHP, который находит ошибки в коде без его выполнения. Он анализирует типы данных, проверяет корректность вызовов методов, обнаруживает недостижимый код и многое другое.

### Конфигурация

- **Уровень:** MAX (самый строгий из 10 уровней)
- **Файлов проанализировано:** 88
- **Включенные правила:**
  - Strict Rules
  - Deprecation Rules
  - Type Coverage

### Результаты

```
> phpstan analyse src tests --level=max
88/88 [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%

[OK] No errors
```

### ✅ Статус: ОТЛИЧНО

**Найдено ошибок:** 0

### Анализ результатов

PHPStan не обнаружил ни одной ошибки на максимальном уровне строгости, что говорит о:

1. **Типобезопасность:** Все типы данных правильно объявлены и используются
2. **Корректность вызовов:** Все вызовы методов и функций корректны
3. **Отсутствие потенциальных багов:** Нет undefined переменных, свойств, методов
4. **Качество кода:** Код написан с соблюдением лучших практик PHP

### Рекомендации

✅ **Текущее состояние идеальное**

- Продолжать использовать строгую типизацию
- Поддерживать уровень MAX в PHPStan
- Регулярно обновлять PHPStan до последней версии

### Примеры проверок PHPStan

```php
// PHPStan проверяет типы параметров
public function dispatch(
    string $uri,           // ✅ Строго типизировано
    string $method,        // ✅ Строго типизировано
    ?string $domain = null // ✅ Nullable тип корректен
): Route {                 // ✅ Возвращаемый тип указан
    // ...
}

// PHPStan проверяет вызовы методов
$route = $router->dispatch('/api/users', 'GET');
// ✅ PHPStan знает, что $route имеет тип Route
$route->getName(); // ✅ PHPStan проверяет наличие метода getName()
```

---

## 2. PHPMD - Анализ качества кода

### Описание

PHP Mess Detector (PHPMD) - инструмент для обнаружения потенциальных проблем в коде PHP, таких как:
- Излишне сложный код
- Неиспользуемый код
- Плохо спроектированный код
- Нарушения принципов проектирования

### Конфигурация

Проверяемые правила (phpmd.xml):
- **Clean Code:** Чистота кода
- **Code Size:** Размер классов и методов
- **Controversial:** Спорные практики
- **Design:** Проектирование
- **Naming:** Именование
- **Unused Code:** Неиспользуемый код

### Результаты

```
> phpmd src text phpmd.xml

(пустой вывод - нет проблем)
```

### ✅ Статус: ОТЛИЧНО

**Найдено проблем:** 0

### Анализ результатов

PHPMD не обнаружил:

1. **Сложного кода:**
   - Нет методов с высокой цикломатической сложностью
   - Нет слишком больших классов или методов
   
2. **Неиспользуемого кода:**
   - Все переменные используются
   - Все параметры методов используются
   - Нет мёртвого кода

3. **Проблем проектирования:**
   - Нет излишней связанности (coupling)
   - Правильное использование ООП

4. **Проблем с именованием:**
   - Все имена соответствуют стандартам
   - Имена переменных, методов, классов понятны и осмысленны

### Примеры хорошего проектирования

```php
// ✅ Хорошее именование
class Router {
    private array $routes = [];
    
    public function addRoute(/* ... */): Route {
        // Метод делает одну вещь - добавляет маршрут
    }
}

// ✅ Низкая сложность
public function dispatch(string $uri, string $method): Route {
    // Логика разбита на методы
    $route = $this->findRouteOptimized($uri, $method);
    // ...
}
```

---

## 3. PHPCS - Проверка стиля кода

### Описание

PHP CodeSniffer (PHPCS) проверяет соответствие кода стандартам оформления. В проекте используется стандарт PSR-12.

### Конфигурация

- **Стандарт:** PSR-12 (PHP-FIG)
- **Проверяемая директория:** src/

### Результаты

```
> phpcs src --standard=PSR12

(пустой вывод - нет нарушений)
```

### ✅ Статус: ОТЛИЧНО

**Найдено нарушений:** 0

### Что проверяется

1. **Отступы:**
   - 4 пробела (не табы)
   - Правильная вложенность

2. **Скобки:**
   - Открывающая фигурная скобка на новой строке для классов
   - Открывающая фигурная скобка на той же строке для методов

3. **Пробелы:**
   - Пробелы вокруг операторов
   - Отсутствие пробелов в конце строк

4. **Длина строк:**
   - Не более 120 символов (рекомендация)

5. **Импорты:**
   - Упорядочены по алфавиту
   - Нет неиспользуемых use

### Примеры соответствия PSR-12

```php
<?php

declare(strict_types=1);

namespace CloudCastle\Http\Router;

use Closure;
use RuntimeException;

class Router
{
    private array $routes = [];

    public function addRoute(
        array $methods,
        string $uri,
        mixed $action
    ): Route {
        // Код
    }
}
```

---

## 4. PHP-CS-Fixer - Автофикс стиля

### Описание

PHP-CS-Fixer автоматически исправляет стиль кода согласно настроенным правилам.

### Результаты

```
> php-cs-fixer fix --dry-run --diff
Loaded config default from ".php-cs-fixer.php"
88/88 [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%

Found 0 of 88 files that can be fixed
```

### ✅ Статус: ОТЛИЧНО

**Файлов требующих исправления:** 0 из 88

### Применяемые правила

- **@PSR12:** Базовый стандарт PSR-12
- **array_syntax:** Короткий синтаксис массивов
- **ordered_imports:** Упорядоченные импорты
- **no_unused_imports:** Удаление неиспользуемых импортов
- **single_quote:** Одинарные кавычки где возможно
- **trailing_comma_in_multiline:** Trailing comma в многострочных конструкциях

---

## 5. Rector - Модернизация кода

### Описание

Rector - инструмент для автоматической модернизации и рефакторинга PHP кода.

### Конфигурация

- **PHP Sets:** PHP 8.1
- **Включенные наборы:**
  - Code Quality
  - Coding Style
  - Dead Code
  - Type Declaration
  - Early Return

### Результаты

```
> rector process --dry-run
87/87 [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%

[OK] Rector is done!
```

### ✅ Статус: ОТЛИЧНО

**Изменений требуется:** 0

### Что проверяет Rector

1. **Современный синтаксис PHP:**
   - Использование новых возможностей PHP 8.1
   - Typed properties
   - Union types
   - Match expressions

2. **Качество кода:**
   - Удаление мёртвого кода
   - Упрощение условий
   - Ранние возвраты (early returns)

3. **Типизация:**
   - Добавление типов где возможно
   - Void return types

### Примечания

Один тестовый файл исключён из проверки (`RealWorldScenariosTest.php`), так как использует параметры специально для тестирования изоляции по портам.

---

## 6. Юнит-тесты

### Описание

Юнит-тесты проверяют отдельные компоненты системы в изоляции.

### Статистика

- **Всего тестов:** 438
- **Пройдено:** 438
- **Провалено:** 0
- **Покрытие кода:** ~95%

### Тестируемые компоненты

#### 6.1 Router (Основной роутер)

**Тесты:**
- Регистрация маршрутов (GET, POST, PUT, PATCH, DELETE, VIEW, ANY, MATCH)
- Диспетчеризация запросов
- Поиск маршрутов
- Кеширование
- Singleton паттерн
- Статистика маршрутов

**Примеры:**
```php
$router = new Router();
$route = $router->get('/users', fn() => 'users');
$dispatched = $router->dispatch('/users', 'GET');
```

#### 6.2 Route (Маршрут)

**Тесты:**
- Создание маршрута
- HTTP методы
- URI паттерны
- Параметры с ограничениями
- Middleware
- Именование
- Теги
- Rate Limiting
- IP фильтрация

**Примеры:**
```php
$route = new Route(['GET'], '/users/{id}', $action);
$route->where('id', '[0-9]+')
      ->name('users.show')
      ->middleware([AuthMiddleware::class])
      ->throttle(60, 1);
```

#### 6.3 RouteCollection

**Тесты:**
- Добавление маршрутов
- Поиск по имени
- Поиск по тегу
- Фильтрация
- Группировка

#### 6.4 RouteGroup (Группы маршрутов)

**Тесты:**
- Создание группы
- Префиксы
- Общий middleware
- Вложенные группы
- Домены и порты

**Примеры:**
```php
$router->group(['prefix' => '/api/v1'], function() {
    $router->get('/users', $action);
    $router->post('/users', $action);
});
```

#### 6.5 Middleware

**Тесты:**
- Регистрация middleware
- Выполнение middleware
- Порядок выполнения
- Глобальный middleware
- Middleware на маршруте

#### 6.6 RateLimiter (Ограничение частоты)

**Тесты:**
- Создание лимитов
- Отслеживание попыток
- Проверка лимитов
- Временные окна
- Множественные идентификаторы
- Разные единицы времени (секунды, минуты, часы, дни)

**Примеры:**
```php
$limiter = new RateLimiter(60, 1); // 60 запросов в минуту
$limiter->attempt('192.168.1.1');
if ($limiter->tooManyAttempts('192.168.1.1')) {
    // Блокировка
}
```

#### 6.7 BanManager (Система блокировки)

**Тесты:**
- Блокировка IP
- Разблокировка
- Проверка блокировки
- Автоблокировка
- Временная блокировка

#### 6.8 UrlGenerator (Генератор URL)

**Тесты:**
- Генерация URL по имени
- Подстановка параметров
- Генерация с доменом
- Генерация с протоколом
- HTTPS принудительно

**Примеры:**
```php
$generator = new UrlGenerator($router);
$url = $generator->generate('users.show', ['id' => 5]);
// /users/5
```

#### 6.9 RouteCache (Кеширование)

**Тесты:**
- Сохранение в кеш
- Загрузка из кеша
- Очистка кеша
- Валидация кеша

#### 6.10 Loaders (Загрузчики маршрутов)

**Тестируемые загрузчики:**

1. **JsonLoader:**
   - Загрузка из JSON
   - Валидация JSON
   - Обработка ошибок

2. **YamlLoader:**
   - Загрузка из YAML
   - Сложные структуры

3. **XmlLoader:**
   - Загрузка из XML
   - DTD валидация

4. **PhpLoader:**
   - Загрузка из PHP файлов
   - Динамические маршруты

5. **AttributeLoader:**
   - Сканирование атрибутов
   - Регистрация контроллеров

**Примеры:**
```php
$loader = new JsonLoader($router);
$loader->load('routes.json');

$loader = new AttributeLoader($router);
$loader->loadFromDirectory('app/Controllers');
```

#### 6.11 Plugins (Система плагинов)

**Тесты:**
- Регистрация плагинов
- Хуки (beforeDispatch, afterDispatch, onException)
- Включение/отключение плагинов
- Глобальные и локальные плагины

---

## 7. Тесты безопасности

### Описание

Специализированные тесты для проверки защиты от различных векторов атак.

### Результаты

**Всего тестов:** 13  
**Пройдено:** 13 ✅  
**Время выполнения:** 106ms  
**Память:** 12 MB  

### Детальные результаты

#### 7.1 Path Traversal Protection ✅

**Что проверяется:** Защита от обхода каталогов

**Тестируемые векторы:**
```
/../../../etc/passwd
/./././etc/passwd
/uploads/../../../config/database.php
```

**Результат:** Все попытки заблокированы

#### 7.2 SQL Injection in Parameters ✅

**Что проверяется:** Защита от SQL инъекций в параметрах маршрутов

**Тестируемые векторы:**
```
/users/1' OR '1'='1
/users/1; DROP TABLE users--
/users/1 UNION SELECT * FROM passwords
```

**Результат:** Параметры безопасно экранируются

#### 7.3 XSS in Route Parameters ✅

**Что проверяется:** Защита от XSS атак

**Тестируемые векторы:**
```
/search/<script>alert('XSS')</script>
/profile/<img src=x onerror=alert(1)>
/page/<svg onload=alert(1)>
```

**Результат:** Опасные символы экранируются

#### 7.4 IP Whitelist Security ✅

**Что проверяется:** Работа IP whitelist

**Сценарий:**
- Маршрут доступен только для 192.168.1.1
- Попытка доступа с других IP блокируется

**Результат:** Whitelist работает корректно

#### 7.5 IP Blacklist Security ✅

**Что проверяется:** Работа IP blacklist

**Сценарий:**
- IP 10.0.0.1 в черном списке
- Попытка доступа блокируется

**Результат:** Blacklist работает корректно

#### 7.6 IP Spoofing Protection ✅

**Что проверяется:** Защита от подмены IP

**Тестируемые заголовки:**
```
X-Forwarded-For: 127.0.0.1, 192.168.1.1
X-Real-IP: 192.168.1.1
```

**Результат:** Система правильно определяет реальный IP

#### 7.7 Domain Security ✅

**Что проверяется:** Ограничение по доменам

**Сценарий:**
- Маршрут только для example.com
- Попытка доступа с other.com блокируется

**Результат:** Доменная изоляция работает

#### 7.8 ReDoS Protection ✅

**Что проверяется:** Защита от Regular Expression DoS

**Тестируемые паттерны:**
```
(a+)+b
(a*)*b
(a|a)*b
```

**Результат:** Опасные регулярные выражения блокируются

#### 7.9 Method Override Attack ✅

**Что проверяется:** Защита от подмены HTTP метода

**Сценарий:**
```
POST /api/users HTTP/1.1
X-HTTP-Method-Override: DELETE
```

**Результат:** Подмена метода игнорируется (если не настроено явно)

#### 7.10 Mass Assignment in Route Params ✅

**Что проверяется:** Защита от mass assignment через параметры

**Результат:** Параметры маршрута изолированы от данных модели

#### 7.11 Cache Injection ✅

**Что проверяется:** Защита кеша от инъекций

**Тестируемые векторы:**
```php
/../cache/routes.php
\0cache\0routes.php
```

**Результат:** Инъекции в кеш невозможны

#### 7.12 Resource Exhaustion ✅

**Что проверяется:** Защита от истощения ресурсов

**Сценарии:**
- Регистрация огромного количества маршрутов
- Глубокая вложенность групп
- Очень длинные URI

**Результат:** Система стабильна под нагрузкой

#### 7.13 Unicode Security Issues ✅

**Что проверяется:** Корректная обработка Unicode

**Тестируемые случаи:**
```
/users/א
/pages/中文
/search/🔍
```

**Результат:** Unicode обрабатывается корректно

### Рекомендации по безопасности

1. **Всегда используйте IP фильтрацию** для административных маршрутов
2. **Включайте Rate Limiting** на публичных endpoints
3. **Используйте HTTPS** в продакшене
4. **Регулярно обновляйте** библиотеку
5. **Мониторьте** подозрительную активность

---

## 8. Тесты производительности

### Описание

Бенчмарк-тесты для измерения производительности основных операций.

### Результаты

**Всего тестов:** 5  
**Пройдено:** 5 ✅  
**Время выполнения:** 23.070s  
**Память:** 30 MB  

### Детальные результаты

#### 8.1 Route Registration Performance ✅

**Что тестируется:** Скорость регистрации маршрутов

**Тест:**
- Регистрация 1,000 маршрутов
- Измерение времени

**Результат:**
- Время: ~3.4ms для 1000 маршрутов
- **~0.0034ms на маршрут**

#### 8.2 Route Matching Performance ✅

**Что тестируется:** Скорость поиска маршрутов

**Тесты:**
- Первый маршрут: 123μs
- Средний маршрут: 1.7ms
- Последний маршрут: 3.4ms

**Оптимизации:**
- URI индекс для точных совпадений
- Method индекс для фильтрации
- Ранний выход при совпадении

#### 8.3 Cached Route Performance ✅

**Что тестируется:** Производительность с кешем

**Результаты:**
- Компиляция: 8.7ms
- Загрузка из кеша: 10.6ms

**Примечание:** В текущей реализации некешированный доступ немного быстрее за счёт оптимизированных индексов.

#### 8.4 Memory Usage ✅

**Что тестируется:** Использование памяти

**Результаты:**
- 100 маршрутов: ~6 MB
- 1,000 маршрутов: ~6 MB
- 10,000 маршрутов: ~14 MB

**На маршрут:** ~1.4 KB

#### 8.5 Group Performance ✅

**Что тестируется:** Производительность групп

**Результат:**
- Время создания группы: 2.6ms
- Минимальный overhead

---

[Продолжение в следующей части...]

---

[⬆ Наверх](#подробные-результаты-тестирования-http-router)

