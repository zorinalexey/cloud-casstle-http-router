[üá∑üá∫ –†—É—Å—Å–∫–∏–π](ru/middleware.md) | [üá∫üá∏ English](en/middleware.md) | [üá©üá™ Deutsch](de/middleware.md) | [üá´üá∑ Fran√ßais](fr/middleware.md) | [üá®üá≥ ‰∏≠Êñá](zh/middleware.md)

[üìö Table of Contents](fr/_table-of-contents.md) | [üè† Home](fr/README.md)

---

# Middleware dans le routeur HTTP CloudCastle

**Langues¬†:** üá∑üá∫ Russe | [üá´üá∑ Anglais](../en/middleware.md) | [üá©üá™ Deutsch](../de/middleware.md) | [üá´üá∑ Fran√ßais](../fr/middleware.md) | [üá®üá≥‰∏≠Êñá](../zh/middleware.md)

[üìö Table des mati√®res](_table-of-contents.md) | [üè† Accueil](LISEZMOI.md)

---

## üìö Bilan

Le middleware est un m√©canisme puissant permettant de traiter les requ√™tes HTTP avant et apr√®s leur routage.

## üéØ Types de middleware

### 1. Intergiciel mondial

S'applique √† **tous les itin√©raires**.

```php
// –ü—Ä–æ—Å—Ç–æ–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π middleware
$router->middleware('cors');

// –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π middleware
$router->middleware(['cors', 'auth', 'log']);

// Custom middleware
$router->middleware(new CustomMiddleware());
```

### 2. Group Middleware

S'applique √† **tous les itin√©raires du groupe**.

```php
$router->group(['middleware' => 'auth'], function($router) {
    $router->get('/profile', 'ProfileController@show');
    $router->get('/settings', 'SettingsController@index');
});

// –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –Ω–∞—Å–ª–µ–¥—É—é—Ç middleware
$router->group(['middleware' => 'cors'], function($router) {
    $router->group(['middleware' => 'auth'], function($router) {
        // Middleware stack: [cors, auth]
        $router->get('/api/user', 'ApiController@user');
    });
});
```

### 3. Route Middleware

S'applique √† **un itin√©raire sp√©cifique**.

```php
$router->get('/admin', 'AdminController@index')
    ->middleware(['auth', 'admin']);

// Chain middleware
$router->get('/special', 'SpecialController@index')
    ->middleware('auth')
    ->middleware('verified')
    ->middleware('premium');
```

## üõ†Ô∏è Middleware int√©gr√©

### 1. CorsMiddleware

**Objectif**¬†: Gestion des en-t√™tes CORS pour les requ√™tes d'origine crois√©e.

**Possibilit√©s¬†:**
- Origines autoris√©es (avec prise en charge des caract√®res g√©n√©riques)
- Allowed methods
- Allowed headers
- Max age
- Credentials support
- Preflight handling

**Configuration compl√®te¬†:**
```php
use CloudCastle\Http\Router\Middleware\CorsMiddleware;

$cors = new CorsMiddleware(
    allowedOrigins: [
        'https://example.com',
        'https://app.example.com',
        // –∏–ª–∏ '*' –¥–ª—è –≤—Å–µ—Ö
    ],
    allowedMethods: [
        'GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'
    ],
    allowedHeaders: [
        'Content-Type',
        'Authorization',
        'X-Requested-With',
        'X-CSRF-TOKEN'
    ],
    maxAge: 86400,           // 24 hours
    allowCredentials: true    // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ cookies
);

$router->middleware($cors);
```

**Configuration simple (d√©veloppement)¬†:**
```php
// –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å—ë (—Ç–æ–ª—å–∫–æ –¥–ª—è development!)
$cors = new CorsMiddleware(
    allowedOrigins: ['*'],
    allowedMethods: ['*'],
    allowedHeaders: ['*']
);
```

**Exemple de r√©alisation¬†:**
```php
// API —Å CORS
$router->group(['prefix' => '/api'], function($router) use ($cors) {
    $router->middleware($cors);
    
    $router->get('/public', 'ApiController@public');
    $router->get('/data', 'ApiController@data');
});
```

**Preflight requests:**
Le middleware CORS g√®re automatiquement les requ√™tes OPTIONS pour le contr√¥le en amont.

---

### 2. AuthMiddleware

**Objectif**¬†: Authentification et autorisation des utilisateurs.

**Possibilit√©s¬†:**
- Bearer token authentication
- Session authentication
- Custom authenticator callback
- Role-based access control
- Multiple roles support

**Utilisation de base¬†:**
```php
use CloudCastle\Http\Router\Middleware\AuthMiddleware;

// –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
$auth = new AuthMiddleware();
$router->get('/profile', 'ProfileController@show')
    ->middleware($auth);
```

**Avec r√¥les¬†:**
```php
// –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
$adminAuth = new AuthMiddleware(
    allowedRoles: ['admin', 'super-admin']
);

$router->get('/admin/users', 'AdminController@users')
    ->middleware($adminAuth);

// –î–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–æ–ª–µ–π
$moderatorAuth = new AuthMiddleware(
    allowedRoles: ['admin', 'moderator', 'editor']
);

$router->get('/content/moderate', 'ModerateController@index')
    ->middleware($moderatorAuth);
```

**Custom Authenticator:**
```php
// API Key authentication
$apiAuth = new AuthMiddleware(
    authenticator: function(): ?array {
        $apiKey = $_SERVER['HTTP_X_API_KEY'] ?? '';
        
        if ($apiKey === 'secret-key-123') {
            return [
                'id' => 1,
                'name' => 'API User',
                'roles' => ['api', 'user']
            ];
        }
        
        return null; // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    },
    allowedRoles: ['api']
);

$router->get('/api/protected', 'ApiController@protected')
    ->middleware($apiAuth);
```

**Exemple d'authentification JWT¬†:**
```php
use Firebase\JWT\JWT;

$jwtAuth = new AuthMiddleware(
    authenticator: function(): ?array {
        $authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
        
        if (!str_starts_with($authHeader, 'Bearer ')) {
            return null;
        }
        
        $token = substr($authHeader, 7);
        
        try {
            $decoded = JWT::decode($token, $key, ['HS256']);
            return [
                'id' => $decoded->user_id,
                'name' => $decoded->name,
                'roles' => $decoded->roles
            ];
        } catch (Exception $e) {
            return null;
        }
    },
    allowedRoles: ['user']
);
```

**Exceptions¬†:**
- `RuntimeException('Unauthorized', 401)` - non autoris√©
- `RuntimeException('Forbidden', 403)` - droits insuffisants

---

### 3. HttpsEnforcement

**Objectif**¬†: Forcer l'utilisation de HTTPS.

```php
use CloudCastle\Http\Router\Middleware\HttpsEnforcement;

$https = new HttpsEnforcement(
    redirect: true,     // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π redirect
    permanent: true     // 301 –≤–º–µ—Å—Ç–æ 302
);

$router->middleware($https);
```

**Application:**
-Applications de production
- Protection des cookies
- Compliance (PCI DSS, GDPR)

---

### 4. SsrfProtection

**Objectif**¬†: Protection contre la falsification de requ√™tes c√¥t√© serveur.

**Fonctionnalit√© unique¬†!**

```php
use CloudCastle\Http\Router\Middleware\SsrfProtection;

$ssrf = new SsrfProtection(
    allowLocalhost: false,
    allowPrivateIps: false,
    allowCloudMetadata: false
);

$router->middleware($ssrf);
```

**Bloque les requ√™tes vers¬†:**
- `http://localhost`
- `http://127.0.0.1`
- `http://192.168.1.1` (private)
- `http://10.0.0.1` (private)
- `http://169.254.169.254` (AWS metadata)
- `http://metadata.google.internal` (GCP metadata)

---

### 5. SecurityLogger

**Objectif**¬†: Journalisation des √©v√©nements de s√©curit√©.

```php
use CloudCastle\Http\Router\Middleware\SecurityLogger;

$logger = new SecurityLogger(__DIR__ . '/logs/security.log');
$router->middleware($logger);
```

**√âv√©nements enregistr√©s¬†:**
- Banned IP attempts
- Rate limit exceeds
- Unauthorized access
- IP filtering blocks
- SSRF attempts

**Format du journal¬†:**
```
[2025-10-18 22:00:15] BLOCKED: IP 1.2.3.4 - Rate limit exceeded on /api/data
[2025-10-18 22:01:30] BANNED: IP 1.2.3.4 - Auto-ban triggered after 100 attempts
[2025-10-18 22:05:45] SUSPICIOUS: IP 5.6.7.8 - Path traversal attempt /../../../etc/passwd
[2025-10-18 22:10:00] BLOCKED: IP 9.10.11.12 - SSRF attempt to http://169.254.169.254
[2025-10-18 22:15:20] UNAUTHORIZED: IP 13.14.15.16 - Failed auth on /admin/dashboard
```

---

## üîå PSR-15 Support

### Utilisation du middleware PSR-15

```php
use CloudCastle\Http\Router\Psr15\Psr15MiddlewareAdapter;
use Some\Psr15\Middleware;

// PSR-15 middleware –≤ —Ä–æ—É—Ç–µ—Ä–µ
$psrMiddleware = new Middleware();
$adapter = new Psr15MiddlewareAdapter(
    $psrMiddleware,
    $serverRequest,
    $response
);

$router->middleware($adapter);
```

### Notre middleware en tant que PSR-15

```php
use CloudCastle\Http\Router\Psr15\RouterMiddlewareBridge;

$ourMiddleware = new AuthMiddleware();
$bridge = new RouterMiddlewareBridge($ourMiddleware);

// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ PSR-15 —Å—Ç–µ–∫–µ
```

---

## üé® Cr√©ation d'un middleware personnalis√©

### Middleware de base

```php
use CloudCastle\Http\Router\Contracts\MiddlewareInterface;

class LoggerMiddleware implements MiddlewareInterface
{
    public function handle(mixed $request, callable $next, array $parameters = []): mixed
    {
        $start = microtime(true);
        
        // Before route handling
        error_log("Request: {$request}");
        
        // Call next middleware
        $response = $next($request);
        
        // After route handling
        $duration = microtime(true) - $start;
        error_log("Duration: {$duration}s");
        
        return $response;
    }
}
```

### Middleware avec configuration

```php
class CacheMiddleware implements MiddlewareInterface
{
    public function __construct(
        private readonly string $cacheDir,
        private readonly int $ttl = 3600
    ) {}
    
    public function handle(mixed $request, callable $next, array $parameters = []): mixed
    {
        $cacheKey = md5($request);
        $cacheFile = $this->cacheDir . '/' . $cacheKey;
        
        // Check cache
        if (file_exists($cacheFile) && 
            (time() - filemtime($cacheFile)) < $this->ttl) {
            return file_get_contents($cacheFile);
        }
        
        // Generate response
        $response = $next($request);
        
        // Store in cache
        file_put_contents($cacheFile, $response);
        
        return $response;
    }
}
```

### Middleware avec injection de d√©pendances

```php
class DatabaseMiddleware implements MiddlewareInterface
{
    public function __construct(
        private readonly PDO $pdo,
        private readonly LoggerInterface $logger
    ) {}
    
    public function handle(mixed $request, callable $next, array $parameters = []): mixed
    {
        $this->pdo->beginTransaction();
        
        try {
            $response = $next($request);
            $this->pdo->commit();
            return $response;
        } catch (Exception $e) {
            $this->pdo->rollBack();
            $this->logger->error('Transaction failed', ['exception' => $e]);
            throw $e;
        }
    }
}
```

## üìä Middleware Stack

### Ordre d'ex√©cution

```php
$router->middleware('global1');
$router->middleware('global2');

$router->group(['middleware' => 'group1'], function($router) {
    $router->get('/test', 'TestController@index')
        ->middleware(['route1', 'route2']);
});

// Execution order:
// 1. global1
// 2. global2
// 3. group1
// 4. route1
// 5. route2
// ‚Üí Controller
// ‚Üê route2 (after)
// ‚Üê route1 (after)
// ‚Üê group1 (after)
// ‚Üê global2 (after)
// ‚Üê global1 (after)
```

### Visualisation de la pile

```
Request
  ‚Üì
[Global1]
  ‚Üì
[Global2]
  ‚Üì
[Group1]
  ‚Üì
[Route1]
  ‚Üì
[Route2]
  ‚Üì
Controller ‚Üí Response
  ‚Üë
[Route2]
  ‚Üë
[Route1]
  ‚Üë
[Group1]
  ‚Üë
[Global2]
  ‚Üë
[Global1]
  ‚Üë
Response
```

## üí° Best Practices

### 1. La commande compte

```php
// –ü–†–ê–í–ò–õ–¨–ù–û: CORS –ø–µ—Ä–µ–¥ Auth
$router->middleware(new CorsMiddleware());
$router->middleware(new AuthMiddleware());

// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: Auth –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç preflight
$router->middleware(new AuthMiddleware());
$router->middleware(new CorsMiddleware()); // –ù–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è OPTIONS
```

### 2. R√©duire les middlewares sur les hot paths

```php
// –•–û–†–û–®–û: middleware —Ç–æ–ª—å–∫–æ –≥–¥–µ –Ω—É–∂–Ω–æ
$router->get('/public', 'PublicController@index'); // fast

// –ü–õ–û–•–û: –ª–∏—à–Ω–∏–π middleware
$router->get('/public', 'PublicController@index')
    ->middleware(['auth', 'admin', 'log', 'analytics']); // slow
```

### 3. Regrouper logiquement

```php
// API –≥—Ä—É–ø–ø–∞
$router->group([
    'prefix' => '/api',
    'middleware' => ['cors', 'rate-limit']
], function($router) {
    
    // Public API
    $router->get('/public', 'ApiController@public');
    
    // Protected API
    $router->group(['middleware' => 'auth'], function($router) {
        $router->get('/user', 'ApiController@user');
    });
});
```

### 4. Utilisez des astuces de type

```php
class TypedMiddleware implements MiddlewareInterface
{
    public function handle(
        mixed $request,
        callable $next,
        array $parameters = []
    ): mixed {
        // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
    }
}
```

## üìä Comparaison des syst√®mes middleware

| Feature | CloudCastle | FastRoute | Symfony | Laravel | Slim | Alto |
|:---|:---:|:---:|:---:|:---:|:---:|:---:|
| Global middleware | ‚úÖ | ‚ùå | ‚ö†Ô∏è | ‚úÖ | ‚úÖ | ‚ùå |
| Group middleware | ‚úÖ | ‚ùå | ‚ö†Ô∏è | ‚úÖ | ‚úÖ | ‚ùå |
| Route middleware | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå |
| PSR-15 | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |
| Built-in middleware | ‚úÖ 5 | ‚ùå | ‚ùå | ‚úÖ 3 | ‚ö†Ô∏è 1 | ‚ùå |
| Custom middleware | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Middleware params | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |

## ‚úÖConclusion

CloudCastle HTTP Router fournit **le syst√®me middleware le plus complet**¬†:

- ‚úÖ 3 niveaux de middleware (global, groupe, route)
- ‚úÖ 5 middleware int√©gr√©s
- ‚úÖCompatibilit√© PSR-15
- ‚úÖ Cr√©ation facile de middleware personnalis√©
- ‚úÖConfiguration flexible

---

*Derni√®re mise √† jour : 18 octobre 2025*

---

[üìö Table des mati√®res](_table-of-contents.md) | [üè† Accueil](LISEZMOI.md)

---

[üìö Table of Contents](fr/_table-of-contents.md) | [üè† Home](fr/README.md)
